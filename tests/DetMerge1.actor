actor DetMerge1 int in1, int in2, bool c_in ==> int out, bool c_out:
  initialize ==> c_out:[false] end
  a: action in1:[i], c_in:[ctrl] ==> out:[i], c_out:[true]
    guard !ctrl
  end
  b: action in2:[i], c_in:[ctrl] ==> out:[i], c_out:[false]
    guard ctrl
  end
end

network Top int in1, int in2 ==> int out :
  
  action in1:1, in2:1 ==> out:2
    ensures out[@] = in1[@]
    ensures out[@+1] = in2[@]
  end
  
  invariant tokens(d,1)
  
  chinvariant @(a) = @(b)
  chinvariant @(c) = @(a)+@(b)
  chinvariant !d[0]
  
  chinvariant rd(b) = rd(a) || rd(b)+1 = rd(a)
  chinvariant rd(a) = rd(b) ==> !next(d)
  chinvariant rd(a) = rd(b)+1 ==> next(d)
  
  chinvariant urd(d) = 1
  chinvariant tot(c) = rd(a)+rd(b)
  chinvariant tot(d) = rd(a)+rd(b)+1
  
  chinvariant tot(c) > 0 ==> c[@] = a[@]
  chinvariant tot(c) > 1 ==> c[@+1] = b[@]
    
  entities
    dm = DetMerge1();
  end
  structure
    a: in1 --> dm.in1;
    b: in2 --> dm.in2;
    c: dm.out --> out;
    d: dm.c_out --> dm.c_in;
  end
end